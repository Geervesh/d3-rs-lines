<html>
  <head>
    <style>
      
    body {
      margin: 1em;
    }

    </style>    
  </head>
  <body>
    <p>The Federal Reserve Bank of St. Louis wrote about <a href="https://fredblog.stlouisfed.org/2016/04/job-polarization/">changes in the U.S. labor market</a>.</p>
    <p>Data us presented here via the <code>d3-rs-lines</code> chart.</p>
    <div id="elm"></div>
        
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/d3-rs-lines.umd-es2015.min.js"></script>
    <script>

    'use strict';
    /*
    LNU02032201, Employment Level: Management, Professional, and Related Occupations (nonroutine cognitive)

    LNU02032205, Employment Level: Sales and Office Occupations (routine cognitive)

    LNU02032210, Employment Level: Construction and Extraction Occupations (routine manual)
    LNU02032211, Employment Level: Installation, Maintenance, and Repair Occupations (routine manual)
    LNU02032212, Employment Level: Production, Transportation and Material Moving Occupations (routine manual)

    LNU02032204, Employment Level: Service Occupations (nonroutine manual)
    */
    
    var mapping = {
      'LNU02032201': 'non-routine cognitive', 
      'LNU02032205': 'routine cognitive', 
      'LNU02032210': 'routine manual',
      'LNU02032211': 'routine manual',
      'LNU02032212': 'routine manual',
      'LNU02032204': 'non-routine manual'
    };
    
    
    var reports = Object.keys(mapping);
    var groups = d3.map(reports.map(k => mapping[k]), d => d ).keys();
    
    var requests = reports.map(id => '/' + id + '.json')
                        .map(function (url) {
                          return new Promise(ok => d3.json(url, ok));  
                        });
   
    Promise.all(requests)
      .then(function (raw) {
        var parseDate = d3.timeParse('%Y-%m-%d');
        
        return d3.nest()
                .key(d => d.r)
                .rollup(a => d3.nest()
                  .key(d => d.l)
                  .rollup(a => d3.sum(a, e => e.v))
                  .entries(a.map(e => e.v)
                            .reduce((a, e) => a.concat(e), [])
                          )
                )
                .entries(raw.map(e => e.observations.map(d => ({ l: d.date, v: parseInt(d.value) })))
                                                    .map((d,i) => ({ r: mapping[reports[i]], v: d }))
                )
                .map(v => v.value.map(d => ({ l: parseDate(d.key), v: d.value })));
      })
      .then(function (data) {
        var display = d3_rs_lines.html()
                .labelTime('%Y')
                .width(700)
                .height(400)
                .fillArea(null)
                .niceIndex('false')
                .legend(groups);
        
        d3.select('#elm').datum(data).call(display);
      })
      .catch(console.error);


    </script>
  </body>
</html>
